(()=>{"use strict";var e=function(){function e(e,t,r,o){this.$http=e,this.$log=t,this.Upload=r,this.urlResource=o}return e.prototype.addRedirect=function(e){return e.is404=!1,this.urlResource.verify(this.$http({url:this.urlResource.getUrl("addRedirect"),method:"POST",data:e}),"Failed to add redirect")},e.prototype.addIgnore404=function(e){return this.urlResource.verify(this.$http({url:this.urlResource.getUrl("addIgnore404"),method:"POST",data:{id:e}}),"Failed to ignore 404")},e.prototype.getRedirects=function(e,t,r,o){return void 0===o&&(o="CreatedDesc"),o||(o="CreatedDesc"),this.urlResource.verify(this.$http({url:this.urlResource.getUrl("getRedirects"),method:"GET",params:{skip:e,amount:t,query:r,sortType:o}}),"Failed to get redirects")},e.prototype.getNotFounds=function(e,t,r,o){return void 0===o&&(o="LastOccurredDesc"),o||(o="LastOccurredDesc"),this.urlResource.verify(this.$http({url:this.urlResource.getUrl("getNotFounds"),method:"GET",params:{skip:e,amount:t,query:r,sortType:o}}),"Failed to get not founds")},e.prototype.updateRedirect=function(e){return this.urlResource.verify(this.$http({url:this.urlResource.getUrl("updateRedirect"),method:"POST",data:e}),"Failed to update redirect")},e.prototype.deleteEntry=function(e,t){return void 0===t&&(t=!1),this.urlResource.verify(this.$http({url:this.urlResource.getUrl("deleteEntry"),method:"POST",params:{id:e,is404:t}}),"Failed to delete entry")},e.prototype.getLanguagesOutNodeDomains=function(e){return this.urlResource.verify(this.$http({url:this.urlResource.getUrl("getLanguagesOutNodeDomains"),method:"GET",params:{nodeId:e}}),"Failed to get languages")},e.prototype.getNodesWithDomains=function(){return this.urlResource.verify(this.$http({url:this.urlResource.getUrl("getNodesWithDomains"),method:"GET"}),"Failed to get nodes with domains")},e.prototype.countNotFoundsThisWeek=function(){return this.urlResource.verify(this.$http({url:this.urlResource.getUrl("countNotFoundsThisWeek"),method:"GET"}),"Failed to get amount of not founds")},e.prototype.getSettings=function(){return this.urlResource.verify(this.$http({url:this.urlResource.getUrl("getSettings"),method:"GET"}),"Failed to get settings")},e.prototype.importRedirects=function(e){return this.urlResource.verify(this.Upload.upload({url:this.urlResource.getUrl("importRedirects"),file:e,fields:{}}),"Failed to import redirects")},e.prototype.exportRedirects=function(){return this.urlResource.download(this.urlResource.getUrl("exportRedirects"))},e.$inject=["$http","$log","Upload","urlTrackerUrlResource"],e}(),t=function(){function e(e,t,r,o,i,n){var s=this;this.$scope=e,this.urlTrackerEntryService=t,this.editorService=r,this.notificationsService=o,this.entityResource=i,this.overlayService=n;var c=this;t.getSettings().then((function(e){s.settings=e})),this.dashboard={notFoundsThisWeek:null,notFounds:{loading:!1,items:[]},redirects:{loading:!1,items:[]}},this.redirects={items:[],numberOfItems:0,selectedItems:[],allSelected:!1,itemsPerPage:20,createButtonState:"init",searchString:"",filter:"CreatedDesc",pagination:{pageNumber:1,totalPages:1},loading:!1},this.notFounds={items:[],numberOfItems:0,selectedItems:[],allSelected:!1,itemsPerPage:20,searchString:"",filter:"LastOccurredDesc",pagination:{pageNumber:1,totalPages:1},loading:!1},t.getNodesWithDomains().then((function(e){i.getByIds(e,"Document").then((function(e){c.allRootNodes=e}))})),this.UpdateDashboard(),this.GetRedirects(this.redirects),this.GetNotFounds(this.notFounds),this.tabs=[{alias:"dashboard",label:"Dashboard",active:!0},{alias:"notFounds",label:"Not founds"},{alias:"redirects",label:"Redirects"}],this.pageSizeOptions=[{value:10},{value:20},{value:30},{value:50},{value:100},{value:200}],this.entryDetailsOverlay={view:"/App_Plugins/UrlTracker/Panels/details.html",size:"small",entry:null,rootNodes:null,submit:function(e){(e.isNewEntry||e.entry.Is404?t.addRedirect(e.entry):t.updateRedirect(e.entry)).then((function(){e.isNewEntry||e.entry.Is404?o.success("Created","Succesfully created a new redirect"):o.success("Edited","Succesfully edited redirect"),r.close(),c.GetRedirects(c.redirects),c.GetNotFounds(c.notFounds),c.UpdateDashboard()})).catch((function(e){o.error("Error","An error occurred: ".concat(e))})),null!=e.rootNodes&&null!=c.entryDetailsOverlay.rootNodes&&(c.entryDetailsOverlay.rootNodes=e.rootNodes)},close:function(e){null!=e.rootNodes&&null!=c.entryDetailsOverlay.rootNodes&&(c.entryDetailsOverlay.rootNodes=e.rootNodes),r.close()}},this.redirects.create=function(){c.entryDetailsOverlay.entry=null,r.open(c.entryDetailsOverlay)},this.redirects.clickItem=function(e){410!=e.RedirectHttpCode&&(c.entryDetailsOverlay.entry=Object.assign({},e),r.open(c.entryDetailsOverlay))},this.redirects.goToPage=function(e){c.redirects.pageNumber!=e&&(c.redirects.pagination.pageNumber=e,c.GetRedirects(c.redirects))},this.redirects.nextPage=function(e){c.redirects.goToPage(e)},this.redirects.prevPage=function(e){c.redirects.goToPage(e)},this.redirects.deleteItem=function(e){null===event||void 0===event||event.stopPropagation(),t.deleteEntry(e.Id).then((function(){c.GetRedirects(c.redirects),o.success("Deleted","Redirect succesfully deleted"),c.UpdateDashboard()}))},this.redirects.pageSizeChanged=function(){c.GetRedirects(c.redirects)},this.redirects.selectAll=function(){c.redirects.allItemsSelected?(c.redirects.allItemsSelected=!1,c.redirects.selectedItems=[]):(c.redirects.allItemsSelected=!0,c.redirects.selectedItems=angular.copy(c.redirects.items))},this.redirects.toggleSelectItem=function(e,t){e.stopPropagation();var r=c.redirects.selectedItems.findIndex((function(e){return e.Id==t.Id}));-1!=r?c.redirects.selectedItems.splice(r,1):c.redirects.selectedItems.push(t)},this.redirects.deleteSelected=function(){var e=[];c.redirects.selectedItems.forEach((function(r){e.push(t.deleteEntry(r.Id))})),Promise.all(e).then((function(){c.redirects.selectedItems=[],c.redirects.allItemsSelected=!1,c.GetRedirects(c.redirects),c.UpdateDashboard(),o.success("Deleted","Redirects succesfully deleted")}))},this.redirects.clearSelection=function(){c.redirects.allItemsSelected=!1,c.redirects.selectedItems=[];for(var e=document.getElementsByClassName("select-redirect"),t=0;t<e.length;t++)"checkbox"==e[t].type&&(e[t].checked=!1)},this.redirects.search=function(){c.redirects.pagination.pageNumber=1,c.GetRedirects(c.redirects)},this.redirects.setFilter=function(e){if(c.redirects.filter&&c.redirects.filter.replace("Asc","").replace("Desc","")==e&&c.redirects.filter.includes("Desc"))return c.redirects.filter="".concat(e,"Asc"),c.GetRedirects(c.redirects);c.redirects.filter="".concat(e,"Desc"),c.GetRedirects(c.redirects)},this.redirects.importExport=function(){n.open({name:"urltracker-import-export-overlay",view:"/App_Plugins/UrlTracker/Overlays/importexport.html",class:"testest",hideSubmitButton:!0,position:"center",style:"width:400px",refreshRedirects:function(){c.UpdateDashboard(),c.GetRedirects(c.redirects)},close:function(){n.close()}})},this.notFounds.createRedirect=function(e){c.entryDetailsOverlay.entry=Object.assign({},e),r.open(c.entryDetailsOverlay)},this.notFounds.goToPage=function(e){c.notFounds.pageNumber!=e&&(c.notFounds.pagination.pageNumber=e,c.GetNotFounds(c.notFounds))},this.notFounds.nextPage=function(e){c.notFounds.goToPage(e)},this.notFounds.prevPage=function(e){c.notFounds.goToPage(e)},this.notFounds.deleteItem=function(e){null===event||void 0===event||event.stopPropagation(),t.deleteEntry(e.Id,!0).then((function(){o.success("Deleted","Not found succesfully deleted"),c.GetNotFounds(c.notFounds),c.UpdateDashboard()}))},this.notFounds.pageSizeChanged=function(){c.GetNotFounds(c.notFounds)},this.notFounds.selectAll=function(){c.notFounds.allItemsSelected?(c.notFounds.allItemsSelected=!1,c.notFounds.selectedItems=[]):(c.notFounds.allItemsSelected=!0,c.notFounds.selectedItems=angular.copy(c.notFounds.items))},this.notFounds.toggleSelectItem=function(e,t){e.stopPropagation();var r=c.notFounds.selectedItems.findIndex((function(e){return e.Id==t.Id}));-1!=r?c.notFounds.selectedItems.splice(r,1):c.notFounds.selectedItems.push(t)},this.notFounds.deleteSelected=function(){var e=[];c.notFounds.selectedItems.forEach((function(r){e.push(t.deleteEntry(r.Id,!0))})),Promise.all(e).then((function(){c.notFounds.selectedItems=[],c.notFounds.allItemsSelected=!1,c.GetNotFounds(c.notFounds),c.UpdateDashboard(),o.success("Deleted","Not founds succesfully deleted")}))},this.notFounds.clearSelection=function(){c.notFounds.allItemsSelected=!1,c.notFounds.selectedItems=[];for(var e=document.getElementsByClassName("select-notfound"),t=0;t<e.length;t++)"checkbox"==e[t].type&&(e[t].checked=!1)},this.notFounds.search=function(){c.notFounds.pagination.pageNumber=1,c.GetNotFounds(c.notFounds)},this.notFounds.addIgnore=function(e){n.open({content:"Are you sure you want to permanently ignore this not found?",submit:function(){t.addIgnore404(e).then((function(){c.GetNotFounds(c.notFounds),o.success("Ignored","Not found succesfully added to ignore list"),c.UpdateDashboard()})),n.close()},close:function(){n.close()}})},this.notFounds.setFilter=function(e){if(c.notFounds.filter&&c.notFounds.filter.replace("Asc","").replace("Desc","")==e&&c.notFounds.filter.includes("Desc"))return c.notFounds.filter="".concat(e,"Asc"),c.GetNotFounds(c.notFounds);c.notFounds.filter="".concat(e,"Desc"),c.GetNotFounds(c.notFounds)},e.$watch("vm.redirects.numberOfItems",(function(){c.tabs.find((function(e){return"redirects"==e.alias})).label="Redirects ("+c.redirects.numberOfItems+")"})),e.$watch("vm.notFounds.numberOfItems",(function(){c.tabs.find((function(e){return"notFounds"==e.alias})).label="Not founds  ("+c.notFounds.numberOfItems+")"}))}return e.prototype.changeTab=function(e){this.tabs.forEach((function(e){return e.active=!1})),this.tabs.find((function(t){return t.alias==e})).active=!0},e.prototype.getSiteName=function(e){if(this.allRootNodes){var t=this.allRootNodes.find((function(t){return t.id==e.RedirectRootNodeId}));if(t)return t.name}},e.prototype.GetRedirects=function(e){var t=0;e.pagination.pageNumber>1&&(t=(e.pagination.pageNumber-1)*e.itemsPerPage),e.loading=!0,this.urlTrackerEntryService.getRedirects(t,e.itemsPerPage,e.searchString,e.filter).then((function(t){e.items=t.Entries,null!=e.pagination&&(e.numberOfItems=t.NumberOfEntries,e.pagination.totalPages=Math.ceil(t.NumberOfEntries/e.itemsPerPage))})).finally((function(){e.loading=!1}))},e.prototype.GetNotFounds=function(e){var t=0;e.pagination.pageNumber>1&&(t=(e.pagination.pageNumber-1)*e.itemsPerPage),e.loading=!0,this.urlTrackerEntryService.getNotFounds(t,e.itemsPerPage,e.searchString,e.filter).then((function(t){e.items=t.Entries,null!=e.pagination&&(e.numberOfItems=t.NumberOfEntries,e.pagination.totalPages=Math.ceil(t.NumberOfEntries/e.itemsPerPage))})).finally((function(){e.loading=!1}))},e.prototype.UpdateDashboard=function(){var e=this;this.dashboard.redirects.loading=!0,this.urlTrackerEntryService.getRedirects(0,10,"","CreatedDesc").then((function(t){e.dashboard.redirects.items=t.Entries,null!=e.dashboard.redirects.pagination&&(e.dashboard.redirects.numberOfItems=t.NumberOfEntries,e.dashboard.redirects.pagination.totalPages=Math.ceil(t.NumberOfEntries/10))})).finally((function(){e.dashboard.redirects.loading=!1})),this.dashboard.notFounds.loading=!0,this.urlTrackerEntryService.getNotFounds(0,10,"","OccurrencesDesc").then((function(t){e.dashboard.notFounds.items=t.Entries,null!=e.dashboard.notFounds.pagination&&(e.dashboard.notFounds.numberOfItems=t.NumberOfEntries,e.dashboard.notFounds.pagination.totalPages=Math.ceil(t.NumberOfEntries/10))})).finally((function(){e.dashboard.notFounds.loading=!1})),this.urlTrackerEntryService.countNotFoundsThisWeek().then((function(t){e.dashboard.notFoundsThisWeek=t}))},e.$inject=["$scope","urlTrackerEntryService","editorService","notificationsService","entityResource","overlayService"],e}(),r=function(){function e(e,t,r,o,i,n,s){var c=this;this.$scope=e,this.$location=t,this.$q=r,this.urlTrackerEntryService=o,this.contentResource=i,this.editorService=n,this.entityResource=s,this.isLoaded=!1,this.previousCulture=null,this.isNewEntry=!1,this.advancedView=!1,this.redirectNode=null,this.loading=!0,this.allowRemove=!0,this.allowOpen=!1,this.sortable=!1,this.nodes=null,this.title=null,this.LoadDomains().then((function(){c.LoadEntry()}));var d=this;e.$watch("vm.entry.Culture",(function(e){d.loading||(t.search().mculture&&(d.previousCulture=t.search().mculture),t.search("mculture",e))}))}return e.prototype.setRootNode=function(e){this.entry.RedirectRootNodeId=e},e.prototype.openNodePicker=function(){var e=this,t={startNodeId:this.entry.RedirectRootNodeId,multiPicker:!1,submit:function(t){e.entry.RedirectNodeName=t.selection[0].name,e.entry.RedirectNodeId=t.selection[0].id,e.entry.RedirectNodeIcon=t.selection[0].icon,e.entityResource.getUrl(e.entry.RedirectNodeId,"Document",e.entry.Culture).then((function(t){e.entry.RedirectNodeUrl=t})),e.editorService.close()},close:function(t){e.editorService.close()}};this.editorService.contentPicker(t)},e.prototype.removeRedirectNode=function(){this.entry.RedirectNodeName=this.entry.RedirectNodeId=this.entry.RedirectNodeIcon=null},e.prototype.saveChanges=function(){this.$scope.model.submit&&(this.$scope.model.isNewEntry=this.isNewEntry,this.$scope.model.entry=this.entry,this.$scope.model.rootNodes=this.rootNodes,this.$location.search("mculture",this.previousCulture),this.$scope.model.submit(this.$scope.model))},e.prototype.close=function(){this.$scope.model.close&&(this.$scope.model.rootNodes=this.rootNodes,this.$location.search("mculture",this.previousCulture),this.$scope.model.close(this.$scope.model))},e.prototype.updateLanguages=function(){var e=this;if(0==this.entry.RedirectRootNodeId||-1==this.entry.RedirectRootNodeId||null==this.rootNodes)this.languages=null,this.entry.Culture=null;else{var t=this.rootNodes.find((function(t){return t.id==e.entry.RedirectRootNodeId}));null!=t&&null!=t.domainLanguages?(this.languages=t.domainLanguages,null!=this.entry.Culture&&this.languages.find((function(t){return t.IsoCode==e.entry.Culture}))||this.languages.length>0&&null!=this.languages[0]&&(this.entry.Culture=this.languages[0].IsoCode)):(this.languages=null,this.entry.Culture=null)}},e.prototype.LoadDomains=function(){var e=this,t=this;return null!=this.$scope.model.rootNodes?this.$q((function(t,r){e.rootNodes=e.$scope.model.rootNodes,t()})):this.$q((function(r,o){e.urlTrackerEntryService.getNodesWithDomains().then((function(e){t.entityResource.getByIds(e,"Document").then((function(e){var o=[];t.rootNodes=e,null!=t.rootNodes&&t.rootNodes.forEach((function(e){o.push(t.urlTrackerEntryService.getLanguagesOutNodeDomains(e.id).then((function(t){e.domainLanguages=t})))})),t.$q.all(o).then((function(){r()}))}))}))}))},e.prototype.LoadEntry=function(){var e=this;null!=this.$scope.model.entry?(this.entry=this.$scope.model.entry,this.entry.Is404?(this.title="Create redirect",this.entry.remove404=!0,this.entry.RedirectHttpCode=301,this.entry.Notes="Redirect created to prevent 404"):(this.title="Edit redirect",this.advancedView=!0),this.entry.RedirectNodeId&&0!=this.entry.RedirectNodeId&&(this.entityResource.getUrl(this.entry.RedirectNodeId,"Document",this.entry.Culture).then((function(t){e.entry.RedirectNodeUrl=t})),this.entityResource.getById(this.entry.RedirectNodeId,"Document",this.entry.Culture).then((function(t){e.entry.RedirectNodeName=t.name,e.entry.RedirectNodeIcon=t.icon})))):(this.title="Create redirect",this.isNewEntry=!0,this.advancedView=!0,this.entry={OldUrl:"",RedirectNodeId:null,OldRexEx:"",RedirectUrl:"",Refferer:"",ForceRedirect:!1,RedirectPassThroughQueryString:!1,RedirectHttpCode:301,Notes:"",RedirectRootNodeId:-1},null!=this.rootNodes&&(this.entry.RedirectRootNodeId=this.rootNodes[0].id)),this.updateLanguages(),this.loading=!1},e.$inject=["$scope","$location","$q","urlTrackerEntryService","contentResource","editorService","entityResource"],e}(),o=function(){function e(e,t,r){this.$scope=e,this.urlTrackerEntryService=t,this.notificationsService=r,this.mode="",this.title="",this.file=null,this.fileInputDisabled=!1,this.export={loading:!1},this.import={loading:!1}}return e.prototype.exportRedirects=function(){var e=this;this.export.loading||(this.export.loading=!0,this.urlTrackerEntryService.exportRedirects().then((function(){e.export.loading=!1})))},e.prototype.importRedirects=function(){this.mode="import",this.title="Import redirects"},e.prototype.back=function(){"import"==this.mode&&1==this.import.loading||(this.mode="",this.title="",this.file=null)},e.prototype.submitImport=function(){var e=this;this.file&&!this.import.loading&&(this.import.loading=!0,this.fileInputDisabled=!0,this.urlTrackerEntryService.importRedirects(this.file).then((function(t){e.notificationsService.success("Success","Succesfully imported ".concat(t," redirects")),e.import.loading=!1,e.fileInputDisabled=!1,e.$scope.model.refreshRedirects()})).catch((function(t){e.notificationsService.error("Error",t.data.Message),e.import.loading=!1,e.fileInputDisabled=!1})))},e.$inject=["$scope","urlTrackerEntryService","notificationsService"],e}(),i=function(){function e(e){this.umbRequestHelper=e}return e.prototype.verify=function(e,t){return this.umbRequestHelper.resourcePromise(e,t),e.then((function(e){return e.data}))},e.prototype.getUrl=function(e){var t=this.urlTrackerSection[e];if(!t)throw new Error("no action associated with given key");return this.urlBase+t},e.prototype.download=function(e){return this.umbRequestHelper.downloadFile(e)},Object.defineProperty(e.prototype,"urlBase",{get:function(){return this.urlTrackerSection.base},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"urlTrackerSection",{get:function(){return Umbraco.Sys.ServerVariables.urlTracker},enumerable:!1,configurable:!0}),e.$inject=["umbRequestHelper"],e}(),n=angular.module("umbraco");n.controller("UrlTracker.OverviewController",t),n.controller("UrlTracker.DetailsController",r),n.controller("UrlTracker.ImportExportOverlayController",o),n.directive("ngEnter",(function(){return{link:function(e,t,r){t.bind("keydown keypress",(function(t){13===t.which&&(e.$apply((function(){e.$eval(r.ngEnter)})),t.preventDefault())}))}}})),n.service("urlTrackerEntryService",e),n.service("urlTrackerUrlResource",i)})();